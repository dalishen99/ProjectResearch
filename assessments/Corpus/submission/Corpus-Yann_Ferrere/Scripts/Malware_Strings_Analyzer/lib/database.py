from datetime import datetime
import re, sqlite3

class Database(object):
    """
        This class is used to interact with database.
    """
    def __init__(self, malware_path):
        """
            Initialize the database and create a table corresponding to the
            malware to analyze.

            :param malware_path: Absolute path to the malware binary.
        """
        self.conn = sqlite3.connect('./db/results.db')
        self.cursor = self.conn.cursor()
        self.malware_name = malware_path.split("/")[-3:]
        del self.malware_name[1]
        self.malware_name = "-".join(self.malware_name) + "_"
        self.malware_name += datetime.now().strftime("%d-%m-%y_%H:%M:%S")
        self.cursor.execute('''CREATE TABLE [{}] (string text, extract text
                            , type text)'''
            .format(self.malware_name))

    def createEntry(self, string, extract, type):
        """
            This methods is used by all rules to create an entry in the current
            table.

            :param string: String that has been analyzed.
            :param extract: Part of the string corresponding to as specific rule.
            :param type: Type of the rule corresponding to the extracted element.
        """
        req = """INSERT INTO [{}](string, extract, type)
                VALUES(?, ?, ?)""".format(self.malware_name)
        self.cursor.execute(req, (string, extract, type))
        self.conn.commit()

    def close(self):
        """
            Close the database.
        """
        self.conn.close()

    def getIpAddresses(self):
        """
            Return all strings detected as an IP address.

            :return: All IP address in the current table.
            :type: List
        """
        req = """select extract from [{}] where type == \"ip\"""" \
                .format(self.malware_name)
        ips_db = self.cursor.execute(req)
        ips = []
        for ip in ips_db.fetchall():
            ips.append(ip[0].split(":")[0])
        return ips

    def getUrls(self):
        """
            Return all strings detected as an URL.

            :return: All URLs in the current table.
            :rtype: List
        """
        req = """select extract from [{}] where type == \"url\"""" \
                .format(self.malware_name)
        urls_db = self.cursor.execute(req)
        urls = []

        regexp = """(?:http|ftp)://[^ /]+"""
        pattern = re.compile(regexp)

        for url in urls_db.fetchall():
            url = url[0]
            if pattern.search(url) is None:
                continue
            urls.append(pattern.search(url).group())
        return urls
