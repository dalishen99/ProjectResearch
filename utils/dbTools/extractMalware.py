#!/usr/bin/env python

import sys, getpass
import MySQLdb
import re
import wget
import os

user = sys.argv[1]
passwd = getpass.getpass()

try:
    db = MySQLdb.connect(host="localhost",
                         user=user,
                         passwd=passwd,
                         db="cowrie")
except:
    print "Error: DB fail to connect."
    sys.exit()


cur = db.cursor()


req_getAll = """select distinct input from input where input like "%wget%" and input not like "wget" and input not like "%do%" and input not like "%mv%" and input not like "%--help%" and input not like "%chmod%" and input not like "%chattr%" and input not like "busybox wget";"""

regex_extractUrl = """(?:(?:http|ftp) : //[^ ]+ : [^ ]+|(?:http|ftp) : //[^ ]+)|http[^ ]+|wget [^ ]+/[^ ]+"""

cur.execute(req_getAll)

rslt = []

for row in cur.fetchall():
#    print row[0]
    cmd = row[0]
    try:
        cmd.decode('ascii')
        rslt.append(re.findall(regex_extractUrl, cmd)[0].replace("wget", "").replace(" ", ""))
    except UnicodeDecodeError:
        print "Error: unicode character detected."
    except:
        print "Error: undefined error occured on \"%s\"" % cmd

output = "../collectedData/malware/%s/"

for url in rslt:
    try:
        folder_name = output % url.replace("://", "").replace("/", "-").replace("http", "").replace("https", "").replace("ftp", "")
        #os.makedirs(folder_name)
        wget.download(url, folder_name + "dl_script3")
    except:
        print "Error: fail to download \"%s\"" % url
        continue
        
db.close()

